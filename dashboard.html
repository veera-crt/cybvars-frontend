<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard | CybVars</title>
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
  />
  <style>
    :root {
      --primary: #4c51bf;
      --primary-light: #5a67d8;
      --primary-dark: #434190;
      --danger: #e53e3e;
      --danger-light: #f56565;
      --success: #38a169;
      --success-light: #48bb78;
      --warning: #dd6b20;
      --text: #2d3748;
      --text-light: #718096;
      --text-lighter: #a0aec0;
      --bg: #f7fafc;
      --bg-dark: #edf2f7;
      --card-bg: #ffffff;
      --border: #e2e8f0;
      --border-dark: #cbd5e0;
      --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      --radius-sm: 0.125rem;
      --radius: 0.25rem;
      --radius-md: 0.375rem;
      --radius-lg: 0.5rem;
      --radius-xl: 0.75rem;
      --radius-2xl: 1rem;
      --radius-full: 9999px;
    }
    
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 0;
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1rem;
    }
    
    header {
      background: var(--card-bg);
      box-shadow: var(--shadow-sm);
      padding: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 50;
    }
    
    .logo {
      font-weight: 700;
      color: var(--primary);
      font-size: 1.25rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      text-decoration: none;
    }
    
    .logo i {
      font-size: 1.1em;
    }
    
    .user-info {
      display: flex;
      align-items: center;
      gap: 1rem;
      font-size: 0.875rem;
    }
    
    #userEmail {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 150px;
    }
    
    .logout-btn {
      background: none;
      border: none;
      color: var(--primary);
      cursor: pointer;
      font-size: 0.875rem;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 0.3rem;
      padding: 0.25rem 0.5rem;
      border-radius: var(--radius);
      transition: all 0.2s ease;
    }
    
    .logout-btn:hover {
      background: rgba(76, 81, 191, 0.1);
    }
    
    .main-content {
      display: grid;
      grid-template-columns: minmax(250px, 300px) 1fr;
      gap: 1.5rem;
      margin-top: 1.5rem;
    }
    
    @media (max-width: 768px) {
      .main-content {
        grid-template-columns: 1fr;
      }
      
      header {
        padding: 0.75rem 1rem;
      }
      
      .logo {
        font-size: 1.1rem;
      }
      
      .user-info {
        gap: 0.75rem;
      }
      
      #userEmail {
        max-width: 120px;
        font-size: 0.8125rem;
      }
      
      .logout-btn span {
        display: none;
      }
      
      .logout-btn i {
        margin-right: 0;
      }
    }
    
    .sidebar {
      background: var(--card-bg);
      border-radius: var(--radius-md);
      padding: 1.25rem;
      box-shadow: var(--shadow-sm);
      height: fit-content;
      position: sticky;
      top: 80px;
    }
    
    .sidebar h3 {
      font-size: 1.125rem;
      margin-top: 0;
      margin-bottom: 1.25rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--primary-dark);
    }
    
    .sidebar h3 i {
      color: var(--primary);
    }
    
    .add-password-form {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 0.375rem;
    }
    
    .form-group label {
      font-weight: 600;
      font-size: 0.875rem;
      color: var(--text);
    }
    
    .form-group input,
    .form-group textarea {
      padding: 0.625rem 0.75rem;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 0.9375rem;
      transition: all 0.2s ease;
      width: 100%;
    }
    
    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(76, 81, 191, 0.2);
    }
    
    .form-group textarea {
      min-height: 100px;
      resize: vertical;
      line-height: 1.5;
    }
    
    .btn {
      padding: 0.6875rem 1.25rem;
      border: none;
      border-radius: var(--radius);
      font-size: 0.9375rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      line-height: 1;
    }
    
    .btn-primary {
      background: var(--primary);
      color: white;
    }
    
    .btn-primary:hover {
      background: var(--primary-light);
      transform: translateY(-1px);
      box-shadow: var(--shadow);
    }
    
    .btn-primary:active {
      transform: translateY(0);
      box-shadow: var(--shadow-sm);
    }
    
    .password-list {
      background: var(--card-bg);
      border-radius: var(--radius-md);
      padding: 1.25rem;
      box-shadow: var(--shadow-sm);
    }
    
    .password-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.25rem;
    }
    
    .password-header h3 {
      font-size: 1.125rem;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--primary-dark);
    }
    
    .password-header h3 i {
      color: var(--primary);
    }
    
    .password-count {
      font-weight: 500;
      color: var(--text-light);
      font-size: 0.8125rem;
      background: var(--bg-dark);
      padding: 0.25rem 0.5rem;
      border-radius: var(--radius-full);
    }
    
    .password-item {
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: 1.25rem;
      margin-bottom: 1rem;
      position: relative;
      transition: all 0.2s ease;
      background: var(--card-bg);
    }
    
    .password-item:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow);
      border-color: var(--primary-light);
    }
    
    .password-website {
      font-weight: 600;
      font-size: 1.0625rem;
      margin-bottom: 0.375rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--primary-dark);
    }
    
    .password-website i {
      color: var(--primary);
      font-size: 0.9em;
    }
    
    .password-username {
      color: var(--text-light);
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
    }
    
    .password-username i {
      font-size: 0.9em;
      color: var(--text-lighter);
    }
    
    .password-value {
      font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
      background: var(--bg-dark);
      padding: 0.5rem 0.75rem;
      border-radius: var(--radius-sm);
      display: inline-flex;
      align-items: center;
      margin-bottom: 0.5rem;
      position: relative;
      padding-right: 2.5rem;
      font-size: 0.9375rem;
      min-height: 2.25rem;
    }
    
    .password-value .toggle-visibility {
      position: absolute;
      right: 0.5rem;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      cursor: pointer;
      color: var(--text-light);
      width: 1.75rem;
      height: 1.75rem;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: var(--radius-sm);
      transition: all 0.2s ease;
    }
    
    .password-value .toggle-visibility:hover {
      background: rgba(0, 0, 0, 0.05);
      color: var(--primary);
    }
    
    .password-notes {
      margin-top: 0.75rem;
      color: var(--text-light);
      font-size: 0.8125rem;
      line-height: 1.5;
      padding-left: 1.5rem;
      position: relative;
    }
    
    .password-notes i {
      position: absolute;
      left: 0;
      top: 0.125rem;
      color: var(--text-lighter);
    }
    
    .password-actions {
      position: absolute;
      top: 0.75rem;
      right: 0.75rem;
      display: flex;
      gap: 0.25rem;
      background: rgba(255, 255, 255, 0.9);
      padding: 0.25rem;
      border-radius: var(--radius);
      box-shadow: var(--shadow-sm);
    }
    
    .action-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 0.875rem;
      color: var(--text-light);
      transition: all 0.2s ease;
      width: 1.75rem;
      height: 1.75rem;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: var(--radius-sm);
    }
    
    .action-btn:hover {
      background: rgba(0, 0, 0, 0.05);
      color: var(--primary);
    }
    
    .action-btn.delete:hover {
      color: var(--danger);
      background: rgba(229, 62, 62, 0.1);
    }
    
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
      padding: 1rem;
    }
    
    .modal.active {
      opacity: 1;
      pointer-events: all;
    }
    
    .modal-content {
      background: white;
      padding: 1.5rem;
      border-radius: var(--radius-lg);
      width: 100%;
      max-width: 400px;
      box-shadow: var(--shadow-lg);
      transform: translateY(-20px);
      transition: transform 0.3s ease;
    }
    
    .modal.active .modal-content {
      transform: translateY(0);
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.25rem;
    }
    
    .modal-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--primary-dark);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .modal-title i {
      color: var(--primary);
    }
    
    .close-btn {
      background: none;
      border: none;
      font-size: 1.25rem;
      cursor: pointer;
      color: var(--text-light);
      transition: color 0.2s ease;
      width: 2rem;
      height: 2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: var(--radius-sm);
    }
    
    .close-btn:hover {
      background: rgba(0, 0, 0, 0.05);
      color: var(--danger);
    }
    
    .otp-input {
      font-size: 1.25rem;
      letter-spacing: 0.5rem;
      text-align: center;
      padding: 0.75rem;
      width: 100%;
      margin-bottom: 1rem;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      transition: all 0.2s ease;
    }
    
    .otp-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(76, 81, 191, 0.2);
    }
    
    .timer {
      text-align: center;
      margin-bottom: 1rem;
      color: var(--text-light);
      font-size: 0.875rem;
    }
    
    .error-message {
      color: var(--danger);
      text-align: center;
      margin-bottom: 1rem;
      padding: 0.75rem;
      background: rgba(229, 62, 62, 0.05);
      border: 1px solid rgba(229, 62, 62, 0.2);
      border-radius: var(--radius);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      font-size: 0.875rem;
    }
    
    .error-message i {
      font-size: 1em;
    }
    
    .success-message {
      color: var(--success);
      text-align: center;
      margin-bottom: 1rem;
      padding: 0.75rem;
      background: rgba(56, 161, 105, 0.05);
      border: 1px solid rgba(56, 161, 105, 0.2);
      border-radius: var(--radius);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      font-size: 0.875rem;
    }
    
    .success-message i {
      font-size: 1em;
    }
    
    .hidden {
      display: none !important;
    }
    
    .inactive-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.85);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      color: white;
      font-size: 1.25rem;
      flex-direction: column;
      gap: 1.5rem;
      backdrop-filter: blur(5px);
      padding: 1.5rem;
      text-align: center;
    }
    
    .inactive-overlay button {
      background: var(--primary);
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: var(--radius);
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .inactive-overlay button:hover {
      background: var(--primary-light);
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }
    
    .inactive-overlay button:active {
      transform: translateY(0);
    }
    
    .strength-bar {
      display: flex;
      gap: 0.25rem;
      margin-bottom: 0.25rem;
      height: 0.375rem;
    }
    
    .strength-bar div {
      flex: 1;
      height: 100%;
      background: #e0e0e0;
      border-radius: var(--radius-full);
      transition: background 0.3s ease;
    }
    
    .strength-text {
      font-size: 0.75rem;
      color: var(--text-light);
      text-align: right;
      margin-top: -0.125rem;
    }
    
    .password-input-container {
      position: relative;
      width: 100%;
    }
    
    .password-input-container input {
      width: 100%;
      padding-right: 2.5rem;
    }
    
    .password-input-container .toggle-password {
      position: absolute;
      right: 0.5rem;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      cursor: pointer;
      color: var(--text-light);
      width: 1.75rem;
      height: 1.75rem;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: var(--radius-sm);
      transition: all 0.2s ease;
    }
    
    .password-input-container .toggle-password:hover {
      background: rgba(0, 0, 0, 0.05);
      color: var(--primary);
    }
    
    .empty-state {
      text-align: center;
      padding: 2rem 1rem;
      color: var(--text-light);
    }
    
    .empty-state i {
      font-size: 2.5rem;
      margin-bottom: 1rem;
      color: var(--border-dark);
      opacity: 0.7;
    }
    
    .empty-state h3 {
      margin-bottom: 0.5rem;
      color: var(--text);
      font-size: 1.125rem;
    }
    
    .empty-state p {
      margin: 0;
      font-size: 0.875rem;
    }
    
    .copy-notification {
      position: fixed;
      bottom: 1.25rem;
      right: 1.25rem;
      background: var(--primary);
      color: white;
      padding: 0.75rem 1.25rem;
      border-radius: var(--radius);
      box-shadow: var(--shadow-md);
      transform: translateY(1.25rem);
      opacity: 0;
      transition: all 0.3s ease;
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
      max-width: calc(100% - 2.5rem);
    }
    
    .copy-notification.show {
      transform: translateY(0);
      opacity: 1;
    }
    
    .search-container {
      margin-bottom: 1.25rem;
      position: relative;
    }
    
    .search-input {
      width: 100%;
      padding: 0.6875rem 1rem 0.6875rem 2.5rem;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 0.9375rem;
      transition: all 0.2s ease;
    }
    
    .search-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(76, 81, 191, 0.2);
    }
    
    .search-icon {
      position: absolute;
      left: 1rem;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-light);
      font-size: 0.9375rem;
    }
    
    .edit-form {
      margin-top: 1.5rem;
      padding-top: 1.5rem;
      border-top: 1px solid var(--border);
    }
    
    /* Loading spinner */
    .spinner {
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    /* Responsive adjustments */
    @media (max-width: 480px) {
      .password-item {
        padding: 1rem;
      }
      
      .password-actions {
        top: 0.5rem;
        right: 0.5rem;
      }
      
      .modal-content {
        padding: 1.25rem;
      }
      
      .inactive-overlay {
        font-size: 1.1rem;
      }
    }
  </style>
</head>
<body>
  <!-- Rest of your HTML remains exactly the same -->
  <header>
    <div class="logo">
      <i class="fas fa-shield-alt"></i>
      <span>CybVars</span>
    </div>
    <div class="user-info">
      <span id="userEmail"></span>
      <button id="logoutBtn" class="logout-btn">
        <i class="fas fa-sign-out-alt"></i>
        <span>Logout</span>
      </button>
    </div>
  </header>

  <div class="container">
    <div class="main-content">
      <!-- Sidebar: Add New Password -->
      <div class="sidebar">
        <h3><i class="fas fa-plus-circle"></i> Add New Password</h3>
        <form id="addPasswordForm" class="add-password-form">
          <div class="form-group">
            <label for="website">Website/Service</label>
            <input type="text" id="website" required placeholder="example.com" />
          </div>
          <div class="form-group">
            <label for="username">Username/Email</label>
            <input type="text" id="username" required placeholder="user@example.com" />
          </div>
          <div class="form-group">
            <label for="password">Password</label>
            <div class="password-input-container">
              <input type="password" id="password" required placeholder="••••••••" />
              <button type="button" id="toggleNewPassword" class="toggle-password">
                <i class="fas fa-eye"></i>
              </button>
            </div>
            <button type="button" id="generatePassword" class="btn">
              <i class="fas fa-key"></i> Generate
            </button>
            <div class="password-strength">
              <div class="strength-bar">
                <div></div><div></div><div></div><div></div>
              </div>
              <div class="strength-text"></div>
            </div>
          </div>
          <div class="form-group">
            <label for="notes">Notes (Optional)</label>
            <textarea id="notes" placeholder="Additional information about this password"></textarea>
          </div>
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-save"></i> Save Password
          </button>
        </form>
      </div>

      <!-- Password List -->
      <div class="password-list">
        <div class="password-header">
          <h3><i class="fas fa-lock"></i> Your Passwords</h3>
          <span id="passwordCount" class="password-count">0 passwords</span>
        </div>
        
        <div class="search-container">
          <i class="fas fa-search search-icon"></i>
          <input type="text" id="searchInput" class="search-input" placeholder="Search passwords..." />
        </div>
        
        <div id="passwordsContainer">
          <div class="empty-state">
            <i class="fas fa-lock-open"></i>
            <h3>No passwords saved yet</h3>
            <p>Add your first password using the form on the left</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- OTP Modal -->
  <div class="modal" id="otpModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title"><i class="fas fa-shield-alt"></i> Verify OTP</div>
        <button id="closeOtpModal" class="close-btn">&times;</button>
      </div>
      <div id="otpTimer" class="timer">OTP valid for 7:00</div>
      <div id="otpError" ">
        <p>Upload your OTP Below</p>
        <span></span>
      </div>
      <div id="otpSuccess" class="success-message hidden">
        <i class=""></i>
        <span></span>
      </div>
      <input type="text" id="otpInput" class="otp-input" maxlength="6" placeholder="000000" />
      <button id="verifyOtpBtn" class="btn btn-primary">
        <i class="fas fa-check"></i> Verify OTP
      </button>
      <div id="editFormContainer" class="edit-form hidden"></div>
    </div>
  </div>

  <!-- Inactivity Overlay -->
  <div id="inactiveOverlay" class="inactive-overlay hidden">
    <div>Your session is about to expire due to inactivity</div>
    <button id="continueSessionBtn">
      <i class="fas fa-play"></i> Continue Session
    </button>
  </div>

  <!-- Your JavaScript remains exactly the same -->
  <script>
    // All your existing JavaScript code goes here unchanged
    // ─── Session & Auth ─────────────────────────────────────────────────────────
    let inactivityTimer;
    const WARNING_TIMEOUT = 24*60*1000;
    let currentActionToken = null; // Store the action token globally
    let currentPwdId = null;
    let currentAction = null;

    function resetInactivityTimer() {
      clearTimeout(inactivityTimer);
      document.getElementById("inactiveOverlay").classList.add("hidden");
      inactivityTimer = setTimeout(() => {
        document.getElementById("inactiveOverlay").classList.remove("hidden");
        setTimeout(logout, 60*1000);
      }, WARNING_TIMEOUT);
    }

    function setupActivityListeners() {
      ["mousemove","keydown","click"].forEach(evt =>
        document.addEventListener(evt, resetInactivityTimer)
      );
      resetInactivityTimer();
    }

    async function checkAuth() {
      try {
        const r = await fetch("https://cybvars-backend-wh7p.onrender.com/api/check-auth", {credentials:"include"});
        if (!r.ok) throw new Error("Auth check failed");
        const data = await r.json();
        return data.success;
      } catch (error) {
        console.error("Auth check error:", error);
        return false;
      }
    }

    function logout() {
      fetch("https://cybvars-backend-wh7p.onrender.com/api/logout", {
        method:"POST", credentials:"include"
      }).then(() => window.location = "login.html");
    }

    // ─── Password Strength & Generator ──────────────────────────────────────────
    function checkPasswordStrength(pwd) {
      let strength = 0;
      const bars = document.querySelectorAll(".strength-bar div");
      const text = document.querySelector(".strength-text");
      const colors = ["#e53e3e", "#dd6b20", "#d69e2e", "#38a169", "#3182ce"];

      bars.forEach(b => b.style.background = "#e0e0e0");
      text.textContent = "";

      if (pwd.length > 7) strength++;
      if (/\d/.test(pwd)) strength++;
      if (/[!@#$%^&*(),.?":{}|<>]/.test(pwd)) strength++;
      if (/[a-z]/.test(pwd) && /[A-Z]/.test(pwd)) strength++;

      const labels = ["Very Weak", "Weak", "Moderate", "Strong", "Very Strong"];
      text.textContent = labels[strength];

      bars.forEach((b, i) => {
        if (i < strength) {
          b.style.background = colors[strength - 1];
        } else {
          b.style.background = "#e0e0e0";
        }
      });
    }

    function generateRandomPassword() {
      const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*()";
      return Array(12).fill(0).map(() => chars[Math.floor(Math.random() * chars.length)]).join("");
    }

    // ─── Load & Render Passwords ────────────────────────────────────────────────
    async function loadPasswords() {
      try {
        const res = await fetch("https://cybvars-backend-wh7p.onrender.com/api/passwords", {credentials:"include"});
        if (!res.ok) throw new Error("Failed to load passwords");
        
        const data = await res.json();
        if (!data.success) {
          logout();
          return;
        }

        const container = document.getElementById("passwordsContainer");
        container.innerHTML = "";
        document.getElementById("passwordCount").textContent =
          `${data.passwords.length} password${data.passwords.length !== 1 ? "s" : ""}`;

        if (data.passwords.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <i class="fas fa-lock-open"></i>
              <h3>No passwords saved yet</h3>
              <p>Add your first password using the form on the left</p>
            </div>
          `;
          return;
        }

        data.passwords.forEach(p => {
          const div = document.createElement("div");
          div.className = "password-item";
          div.innerHTML = `
            <div class="password-website">
              <i class="fas fa-globe"></i>
              ${escapeHtml(p.website)}
            </div>
            <div class="password-username">
              <i class="fas fa-user"></i>
              ${escapeHtml(p.username)}
            </div>
            <div class="password-value" id="password-${p.id}" data-visible="false">
              ••••••••
              <button class="action-btn toggle-visibility" data-id="${p.id}">
                <i class="fas fa-eye"></i>
              </button>
            </div>
            ${p.notes ? `<div class="password-notes"><i class="fas fa-sticky-note"></i> ${escapeHtml(p.notes)}</div>` : ''}
            <div class="password-actions">
              <button class="action-btn copy" data-id="${p.id}" title="Copy">
                <i class="fas fa-copy"></i>
              </button>
              <button class="action-btn modify" data-id="${p.id}" title="Edit">
                <i class="fas fa-edit"></i>
              </button>
              <button class="action-btn delete" data-id="${p.id}" title="Delete">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          `;
          container.appendChild(div);
        });

        attachPasswordVisibilityToggles();
        attachPasswordActions();
      } catch (error) {
        console.error("Error loading passwords:", error);
        showError("Failed to load passwords. Please try again.");
      }
    }

   // ─── Toggle Visibility (decrypt on eye-click) ──────────────────────────────
function attachPasswordVisibilityToggles() {
  document.querySelectorAll(".toggle-visibility").forEach(btn => {
    btn.onclick = async e => {
      e.stopPropagation();
      const id = btn.dataset.id;
      const el = document.getElementById(`password-${id}`);
      const isVisible = el.dataset.visible === "true";

      if (isVisible) {
        // Hide the password
        el.innerHTML = '••••••••';
        const toggleBtn = document.createElement('button');
        toggleBtn.className = 'action-btn toggle-visibility';
        toggleBtn.dataset.id = id;
        toggleBtn.innerHTML = '<i class="fas fa-eye"></i>';
        el.appendChild(toggleBtn);
        el.dataset.visible = "false";
        
        // Reattach event listener to the new button
        toggleBtn.onclick = btn.onclick;
      } else {
        try {
          // Show the password
          const r = await fetch(`https://cybvars-backend-wh7p.onrender.com/api/passwords/${id}`, {credentials:"include"});
          if (!r.ok) throw new Error("Failed to fetch password");
          const d = await r.json();
          
          if (d.success && d.data) {
            el.innerHTML = '';
            const passwordText = document.createTextNode(d.data.password);
            el.appendChild(passwordText);
            
            const toggleBtn = document.createElement('button');
            toggleBtn.className = 'action-btn toggle-visibility';
            toggleBtn.dataset.id = id;
            toggleBtn.innerHTML = '<i class="fas fa-eye-slash"></i>';
            el.appendChild(toggleBtn);
            el.dataset.visible = "true";
            
            // Reattach event listener to the new button
            toggleBtn.onclick = btn.onclick;
          }
        } catch (error) {
          console.error("Error toggling password visibility:", error);
          showError("Failed to reveal password. Please try again.");
        }
      }
    };
  });
}
// ─── Copy / Modify / Delete Actions ─────────────────────────────────────────
function attachPasswordActions() {
  document.querySelectorAll(".copy").forEach(btn => {
    btn.onclick = async e => {
      e.stopPropagation();
      const id = btn.dataset.id;
      const el = document.getElementById(`password-${id}`);
      
      try {
        let password;
        if (el.dataset.visible === "true") {
          // Get password from visible text (excluding the button text)
          password = el.childNodes[0].textContent.trim();
        } else {
          const r = await fetch(`https://cybvars-backend-wh7p.onrender.com/api/passwords/${id}`, {credentials:"include"});
          if (!r.ok) throw new Error("Failed to fetch password");
          const d = await r.json();
          password = d.data.password;
        }
        
        await navigator.clipboard.writeText(password);
        showCopyNotification();
      } catch (error) {
        console.error("Error copying password:", error);
        showError("Failed to copy password. Please try again.");
      }
    };
  });

  // Rest of the attachPasswordActions function remains the same
  document.querySelectorAll(".delete").forEach(btn => {
    btn.onclick = () => {
      currentAction = "delete";
      currentPwdId = btn.dataset.id;
      showOtpModal();
    };
  });

  document.querySelectorAll(".modify").forEach(btn => {
    btn.onclick = () => {
      currentAction = "modify";
      currentPwdId = btn.dataset.id;
      showOtpModal();
    };
  });
}
    function showCopyNotification() {
      const notification = document.createElement('div');
      notification.className = 'copy-notification';
      notification.innerHTML = `
        <i class="fas fa-check-circle"></i>
        <span>Password copied to clipboard!</span>
      `;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.classList.add('show');
      }, 10);
      
      setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => {
          document.body.removeChild(notification);
        }, 300);
      }, 2000);
    }

    function showError(message) {
      const errorEl = document.getElementById("otpError");
      if (errorEl) {
        errorEl.querySelector("span").textContent = message;
        errorEl.classList.remove("hidden");
      } else {
        // Fallback if error element doesn't exist
        alert(message);
      }
    }

    // ─── OTP Modal Logic ───────────────────────────────────────────────────────
    let otpInterval;
    function showOtpModal() {
      const m = document.getElementById("otpModal");
      document.getElementById("otpError").classList.add("hidden");
      document.getElementById("otpSuccess").classList.add("hidden");
      document.getElementById("otpInput").value = "";
      document.getElementById("editFormContainer").classList.add("hidden");

      fetch("https://cybvars-backend-wh7p.onrender.com/api/generate-otp", {
        method: "POST",
        credentials: "include"
      })
      .then(r => r.json())
      .then(d => {
        if (d.success) {
          m.classList.add("active");
          startOtpTimer();
        } else {
          showError(d.message || "Failed to generate OTP");
        }
      })
      .catch(error => {
        console.error("Error generating OTP:", error);
        showError("Failed to generate OTP. Please try again.");
      });
    }

    function startOtpTimer() {
      let t = 7 * 60;
      clearInterval(otpInterval);
      
      const updateTimer = () => {
        const min = Math.floor(t / 60);
        const sec = t % 60;
        document.getElementById("otpTimer").textContent =
          `OTP valid for ${min}:${sec.toString().padStart(2, "0")}`;
        
        if (t-- <= 0) {
          clearInterval(otpInterval);
          showError("OTP expired. Please request a new one.");
        }
      };
      
      updateTimer();
      otpInterval = setInterval(updateTimer, 1000);
    }

    document.getElementById("verifyOtpBtn").onclick = verifyOtpForAction;

   function verifyOtpForAction() {
    const otp = document.getElementById("otpInput").value.trim();
    if (!/^\d{6}$/.test(otp)) {
        showError("Please enter a valid 6-digit OTP");
        return;
    }
    
    // Show loading state
    const verifyBtn = document.getElementById("verifyOtpBtn");
    verifyBtn.disabled = true;
    verifyBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verifying...';
    
    fetch("https://cybvars-backend-wh7p.onrender.com/api/verify-action-otp", {
        method: "POST",
        credentials: "include",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({otp: otp})
    })
    .then(async r => {
        const d = await r.json();
        if (!r.ok) {
            // Handle specific error messages from backend
            const errorMsg = d.message || "OTP verification failed";
            throw new Error(errorMsg);
        }
        return d;
    })
    .then(d => {
        currentActionToken = d.action_token;
        
        if (currentAction === "delete") {
            deletePassword(currentActionToken);
        } else if (currentAction === "modify") {
            document.getElementById("otpError").classList.add("hidden");
            document.getElementById("otpSuccess").querySelector("span").textContent = "OTP Verified!";
            document.getElementById("otpSuccess").classList.remove("hidden");
            showPasswordEditForm();
        }
    })
    .catch(error => {
        console.error("OTP verification error:", error);
        showError(error.message || "OTP verification failed. Please try again.");
    })
    .finally(() => {
        verifyBtn.disabled = false;
        verifyBtn.innerHTML = '<i class="fas fa-check"></i> Verify OTP';
    });
}
    function deletePassword(token) {
      fetch(`https://cybvars-backend-wh7p.onrender.com/api/passwords/${currentPwdId}`, {
        method: "DELETE",
        credentials: "include",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({action_token: token})
      })
      .then(async r => {
        const d = await r.json();
        if (!r.ok) throw new Error(d.message || "Delete failed");
        return d;
      })
      .then(d => {
        if (d.success) {
          document.getElementById("otpModal").classList.remove("active");
          loadPasswords();
        }
      })
      .catch(error => {
        console.error("Error deleting password:", error);
        showError(error.message || "Failed to delete password");
      });
    }

    function showPasswordEditForm() {
      fetch(`https://cybvars-backend-wh7p.onrender.com/api/passwords/${currentPwdId}`, {credentials:"include"})
      .then(async r => {
        const d = await r.json();
        if (!r.ok) throw new Error(d.message || "Failed to load password");
        return d;
      })
      .then(d => {
        const c = document.getElementById("editFormContainer");
        c.innerHTML = `
          <div class="form-group">
            <label>Website/Service</label>
            <input id="editWebsite" value="${escapeHtml(d.data.website || '')}" />
          </div>
          <div class="form-group">
            <label>Username</label>
            <input id="editUsername" value="${escapeHtml(d.data.username || '')}" />
          </div>
          <div class="form-group">
            <label>Password</label>
            <div class="password-input-container">
              <input type="password" id="editPassword" value="${escapeHtml(d.data.password || '')}" />
              <button type="button" id="toggleEditPassword" class="toggle-password">
                <i class="fas fa-eye"></i>
              </button>
            </div>
            <button type="button" id="generateEditPassword" class="btn">
              <i class="fas fa-key"></i> Generate New
            </button>
            
          <div class="form-group">
            <label>Notes</label>
            <textarea id="editNotes">${escapeHtml(d.data.notes || '')}</textarea>
          </div>
          <button id="saveEditBtn" class="btn btn-primary">
            <i class="fas fa-save"></i> Save Changes
          </button>
          <div id="editError" class="error-message hidden"></div>
        `;
        
        // Initialize password strength meter
        checkPasswordStrength(d.data.password || '');
        document.getElementById("editPassword").addEventListener("input", e => {
          checkPasswordStrength(e.target.value);
        });
        
        // Setup password toggle
        document.getElementById("toggleEditPassword").onclick = function() {
          const pwdInput = document.getElementById("editPassword");
          const icon = this.querySelector("i");
          if (pwdInput.type === "password") {
            pwdInput.type = "text";
            icon.classList.replace("fa-eye", "fa-eye-slash");
          } else {
            pwdInput.type = "password";
            icon.classList.replace("fa-eye-slash", "fa-eye");
          }
        };
        
        // Generate new password
        document.getElementById("generateEditPassword").onclick = function() {
          const newPwd = generateRandomPassword();
          document.getElementById("editPassword").value = newPwd;
          checkPasswordStrength(newPwd);
        };
        
        c.classList.remove("hidden");
        
        document.getElementById("saveEditBtn").onclick = () => {
          savePasswordChanges(currentPwdId, currentActionToken);
        };
      })
      .catch(error => {
        console.error("Error loading password for edit:", error);
        showError(error.message || "Failed to load password");
      });
    }

    function deletePassword(token) {
    fetch(`https://cybvars-backend-wh7p.onrender.com/api/passwords/${currentPwdId}`, {
        method: "DELETE",
        credentials: "include",
        headers: {
            "Content-Type": "application/json",
            "Accept": "application/json"  // Explicitly ask for JSON
        },
        body: JSON.stringify({action_token: token})
    })
    .then(async response => {
        // First check if the response is JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            const text = await response.text();
            throw new Error(`Expected JSON but got: ${text.substring(0, 100)}`);
        }
        return response.json();
    })
    .then(data => {
        if (!data.success) {
            throw new Error(data.message || "Delete failed");
        }
        document.getElementById("otpModal").classList.remove("active");
        loadPasswords();
    })
    .catch(error => {
        console.error("Error deleting password:", error);
        showError(error.message || "Failed to delete password. Server returned invalid response.");
    });
}
    function savePasswordChanges(passwordId, actionToken) {
      const errorEl = document.getElementById("editError");
      errorEl.classList.add("hidden");

      const payload = {
        website: document.getElementById("editWebsite").value,
        username: document.getElementById("editUsername").value,
        password: document.getElementById("editPassword").value,
        notes: document.getElementById("editNotes").value,
        action_token: actionToken
      };

      // Basic validation
      if (!payload.website || !payload.username || !payload.password) {
        errorEl.innerHTML = `<i class="fas fa-exclamation-circle"></i> Please fill in all required fields`;
        errorEl.classList.remove("hidden");
        return;
      }

      fetch(`https://cybvars-backend-wh7p.onrender.com/api/passwords/${passwordId}`, {
        method: "PUT",
        credentials: "include",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(payload)
      })
      .then(async r => {
        const data = await r.json();
        if (!r.ok) throw new Error(data.message || "Update failed");
        return data;
      })
      .then(data => {
        if (data.success) {
          document.getElementById("editFormContainer").innerHTML = `
            <div class="success-message">
              <i class="fas fa-check-circle"></i>
              Password updated successfully!
            </div>
            <button onclick="window.location.reload()" class="btn btn-primary">
              <i class="fas fa-sync-alt"></i> Refresh Page
            </button>
          `;
        }
      })
      .catch(error => {
        console.error("Error updating password:", error);
        errorEl.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${error.message || "Update failed"}`;
        errorEl.classList.remove("hidden");
      });
    }

    function escapeHtml(unsafe) {
      return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    // ─── Initialization ─────────────────────────────────────────────────────────
    document.addEventListener("DOMContentLoaded", async () => {
      try {
        if (!(await checkAuth())) {
          window.location = "login.html";
          return;
        }
        
        const auth = await fetch("https://cybvars-backend-wh7p.onrender.com/api/check-auth", {credentials:"include"})
          .then(r => r.json());
        
        document.getElementById("userEmail").textContent = auth.email;
        loadPasswords();
        setupActivityListeners();
        
        // Setup search functionality
        document.getElementById("searchInput").addEventListener("input", function() {
          const searchTerm = this.value.toLowerCase();
          const items = document.querySelectorAll(".password-item");
          
          items.forEach(item => {
            const text = item.textContent.toLowerCase();
            item.style.display = text.includes(searchTerm) ? "" : "none";
          });
        });
        
        // Toggle new-password visibility
        document.getElementById("toggleNewPassword").onclick = e => {
          e.preventDefault();
          const inp = document.getElementById("password");
          const icon = e.currentTarget.querySelector("i");
          if (inp.type === "password") {
            inp.type = "text";
            icon.classList.replace("fa-eye", "fa-eye-slash");
          } else {
            inp.type = "password";
            icon.classList.replace("fa-eye-slash", "fa-eye");
          }
        };
        
        // Submit new-password form
        document.getElementById("addPasswordForm").addEventListener("submit", async e => {
          e.preventDefault();
          const payload = {
            website: document.getElementById("website").value,
            username: document.getElementById("username").value,
            password: document.getElementById("password").value,
            notes: document.getElementById("notes").value
          };
          
          try {
            const r = await fetch("https://cybvars-backend-wh7p.onrender.com/api/passwords", {
              method: "POST",
              credentials: "include",
              headers: {"Content-Type": "application/json"},
              body: JSON.stringify(payload)
            });
            
            if (!r.ok) throw new Error("Failed to save password");
            const d = await r.json();
            
            if (d.success) {
              e.target.reset();
              loadPasswords();
            }
          } catch (error) {
            console.error("Error saving password:", error);
            showError("Failed to save password. Please try again.");
          }
        });
        
        // Strength meter on input
        document.getElementById("password").addEventListener("input", e => {
          checkPasswordStrength(e.target.value);
        });
        
        // Generate-password
        document.getElementById("generatePassword").onclick = () => {
          const pwd = generateRandomPassword();
          document.getElementById("password").value = pwd;
          checkPasswordStrength(pwd);
        };
        
        // Continue session / close OTP modal
        document.getElementById("continueSessionBtn").onclick = resetInactivityTimer;
        document.getElementById("closeOtpModal").onclick = () => {
          document.getElementById("otpModal").classList.remove("active");
        };
        
        // Logout
        document.getElementById("logoutBtn").onclick = logout;
        
      } catch (error) {
        console.error("Initialization error:", error);
        showError("Failed to initialize application. Please refresh the page.");
      }
    });
  </script>
</body>
</html>
